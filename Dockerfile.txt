# --- STAGE 1: BUILD FRONTEND (Vite) ---
FROM node:20-alpine AS builder

WORKDIR /app

# Argumento de construcción para la API_KEY (Gemini/IA)
ARG API_KEY
ENV API_KEY=$API_KEY

# Copiar archivos de configuración de dependencias
COPY package*.json ./

# Instalar todas las dependencias incluyendo devDeps para el build
RUN npm install

# Copiar el resto del código fuente
COPY . .

# Compilar el frontend (Vite genera la carpeta /dist)
RUN npm run build

# --- STAGE 2: PRODUCTION SERVER (Node.js) ---
FROM node:20-alpine

WORKDIR /app

# Configuración de entorno y zona horaria para México
RUN apk add --no-cache tzdata
ENV TZ=America/Mexico_City
ENV NODE_ENV=production
ENV PORT=3000

# Metadatos de versión sincronizados con server/index.js
LABEL version="1.2.4"
LABEL description="SuperAir ERP Production Environment - Security & Interceptor Patches"

# Inyectar API_KEY en el entorno de ejecución del servidor
ARG API_KEY
ENV API_KEY=$API_KEY

# Preparar directorio de persistencia para activos dinámicos (logos, PDFs)
RUN mkdir -p /app/uploads && chown -R node:node /app/uploads

# Copiar dependencias exclusivas de producción para optimizar imagen
COPY --chown=node:node package*.json ./
RUN npm install --omit=dev

# Copiar el core del servidor y el bundle compilado del frontend
COPY --chown=node:node server ./server
COPY --chown=node:node --from=builder /app/dist ./dist

# Puerto expuesto para el orquestador
EXPOSE 3000

# Healthcheck avanzado para monitorear estado de API y DB
HEALTHCHECK --interval=30s --timeout=10s --start-period=20s --retries=3 \
  CMD node -e "fetch('http://localhost:3000/api/health').then((r) => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"

# Seguridad: Ejecutar proceso como usuario limitado
USER node

# Punto de entrada principal
CMD ["node", "server/index.js"]